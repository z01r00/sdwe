<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.title }} - SyncPlay</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>
<body>
    <header class="dark-header">
        <div class="logo">SyncPlay</div>
        <nav>
            <a href="/">é¦–é¡µ</a>
            {% if 'user_id' in session %}
                <a href="/upload">ä¸Šä¼ è§†é¢‘</a>
            {% endif %}
        </nav>
        <nav>
            <a href="https://api.amemv.com/magic/eco/runtime/release/6461f944e84c15036369f2a8?appType=douyinpc&magic_page_no=1&call_link=vega%3A%2F%2Fcom.ies.videocut%2Fmain%2Fdraft%2Fnew_draft%3F%3Ffrom%3Ddouyin_post_panel">å‰ªæ˜ ä¸“ä¸šç‰ˆ</a>
        </nav>
        <div class="user-nav">
            {% if 'user_id' in session %}
                <a href="/user/{{ session['username'] }}">{{ session['username'] }}</a>
                <a href="{{ url_for('logout') }}">é€€å‡º</a>
            {% else %}
                <a href="{{ url_for('login') }}">ç™»å½•</a>
                <a href="{{ url_for('register') }}">æ³¨å†Œ</a>
            {% endif %}
        </div>
        <form class="search-box" action="/search" method="get">
            <input type="text" name="q" placeholder="æœç´¢è§†é¢‘...">
            <button type="submit">æœç´¢</button>
        </form>
    </header>

    <main class="video-container">
        <div class="video-player">
            <video id="mainVideo" controls autoplay loop controlsList="nodownload" oncontextmenu="return false;">
                <source src="{{ url_for('static', filename='videos/' + video.safe_filename) }}" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
            <div id="danmuContainer"></div>
        </div>
        
        <div class="video-details">
            <h1>{{ video.title }}</h1>
            <div class="stats">
                <span>æ’­æ”¾: {{ video.views }}</span>
                <span>ä¸Šä¼ æ—¶é—´: {{ video.upload_date }}</span>
            </div>
            
            <div class="author-info">
                <div class="author-avatar">
                    <img src="{{ url_for('static', filename='avatars/' + author_avatar) }}" 
                         alt="{{ video.author }}çš„å¤´åƒ" width="40" height="40">
                </div>
                <span>ä½œè€…: <a href="/user/{{ video.author }}">{{ video.author }}</a></span>
                {% if 'user_id' in session and session['username'] != video.author %}
                <button class="follow-btn {% if video.author in current_user_following %}following{% endif %}" 
                        onclick="followUser('{{ video.author }}')">
                    {% if video.author in current_user_following %}å·²å…³æ³¨{% else %}å…³æ³¨{% endif %}
                </button>
                {% endif %}
                <span class="followers">ç²‰ä¸: {{ author_followers }}</span>
            </div>
            
            <div class="actions">
                <button class="like-btn {% if liked %}liked{% endif %}" id="likeBtn" onclick="likeVideo()">
                    <span id="likeIcon">{% if liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                    <span id="likeCount">{{ video.likes }}</span>
                </button>
                <button class="fav-btn {% if favorited %}favorited{% endif %}" id="favBtn" onclick="favoriteVideo()">
                    <span id="favIcon">{% if favorited %}â˜…{% else %}â˜†{% endif %}</span>
                    <span id="favCount">{{ video.favorites }}</span>
                </button>
                <button class="share-btn" onclick="openShareModal()">åˆ†äº«</button>
            </div>
        </div>
        
        <!-- åˆ†äº«æ¨¡æ€æ¡† -->
        <div class="share-modal" id="shareModal">
            <div class="share-content">
                <span class="close" onclick="closeShareModal()">&times;</span>
                <h3>åˆ†äº«è§†é¢‘</h3>
                <div class="share-link">
                    <input type="text" id="shareUrl" readonly value="{{ request.url }}">
                    <button onclick="copyShareLink()">å¤åˆ¶é“¾æ¥</button>
                </div>
                <div class="social-share">
                    <button class="social-btn wechat" onclick="shareToWechat()">å¾®ä¿¡</button>
                    <button class="social-btn qq" onclick="shareToQQ()">QQ</button>
                    <button class="social-btn weibo" onclick="shareToWeibo()">å¾®åš</button>
                </div>
            </div>
        </div>
        
        <div class="comments-section">
            <h3>è¯„è®º</h3>
            
            <div class="comment-form">
                <textarea id="commentInput" placeholder="å‘è¡¨ä½ çš„è¯„è®º..."></textarea>
                <button onclick="postComment()">å‘å¸ƒ</button>
            </div>
            
            <div class="comments-list">
                {% for comment in comments %}
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">{{ comment.author }}</span>
                        <span class="comment-time">{{ comment.time }}</span>
                    </div>
                    <div class="comment-content">{{ comment.text }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <footer class="dark-footer">
        <p>SyncPlay &copy; 2025</p>
    </footer>
    
    <script>
    function followUser(username) {
        fetch(`/follow/${username}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const btn = document.querySelector('.follow-btn');
                const followersSpan = document.querySelector('.followers');
                
                // åŒæ—¶æ›´æ–°æ–‡æœ¬å’Œç±»å
                if (data.action === 'follow') {
                    btn.textContent = 'å·²å…³æ³¨';
                    btn.classList.add('following');
                } else {
                    btn.textContent = 'å…³æ³¨';
                    btn.classList.remove('following');
                }
                
                // æ›´æ–°ç²‰ä¸æ•°æ˜¾ç¤º
                followersSpan.textContent = `ç²‰ä¸: ${data.followers}`;
            }
        })
        .catch(error => console.error('Error:', error));
    }
    
    function likeVideo() {
        fetch(`/video/${'{{ video.id }}'}/like`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const btn = document.getElementById('likeBtn');
                const icon = document.getElementById('likeIcon');
                const count = document.getElementById('likeCount');
                
                count.textContent = data.likes;
                
                if (data.action === 'like') {
                    btn.classList.add('liked');
                    icon.textContent = 'â¤ï¸';
                } else {
                    btn.classList.remove('liked');
                    icon.textContent = 'ğŸ¤';
                }
            }
        });
    }
    
    function favoriteVideo() {
        fetch(`/video/${'{{ video.id }}'}/favorite`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const btn = document.getElementById('favBtn');
                const icon = document.getElementById('favIcon');
                const count = document.getElementById('favCount');
                
                count.textContent = data.favorites;
                
                if (data.action === 'favorite') {
                    btn.classList.add('favorited');
                    icon.textContent = 'â˜…';
                } else {
                    btn.classList.remove('favorited');
                    icon.textContent = 'â˜†';
                }
            }
        });
    }
    
    function openShareModal() {
        document.getElementById('shareModal').style.display = 'block';
    }
    
    function closeShareModal() {
        document.getElementById('shareModal').style.display = 'none';
    }
    
    function copyShareLink() {
        const shareUrl = document.getElementById('shareUrl');
        shareUrl.select();
        document.execCommand('copy');
        alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
    
    function shareToWechat() {
        alert('å¾®ä¿¡åˆ†äº«åŠŸèƒ½');
    }
    
    function shareToQQ() {
        window.open(`http://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(window.location.href)}&title=${document.title}`);
    }
    
    function shareToWeibo() {
        window.open(`http://service.weibo.com/share/share.php?url=${encodeURIComponent(window.location.href)}&title=${document.title}`);
    }
    
    // å¼¹å¹•ç³»ç»Ÿ
    const danmuContainer = document.getElementById('danmuContainer');
    const video = document.getElementById('mainVideo');
    
    function sendDanmu() {
        const text = document.getElementById('danmuInput').value.trim();
        if (!text) return;
        
        // å‘é€å¼¹å¹•åˆ°æœåŠ¡å™¨
        fetch(`/video/${'{{ video.id }}'}/danmu`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text: text })
        });
        
        // æœ¬åœ°æ˜¾ç¤º
        displayDanmu(text);
        document.getElementById('danmuInput').value = '';
    }
    
    function displayDanmu(text) {
        const danmu = document.createElement('div');
        danmu.className = 'danmu';
        danmu.textContent = text;
        
        // éšæœºä½ç½®å’Œé¢œè‰²
        const top = Math.random() * 80 + 5; // 5% - 85%
        danmu.style.top = `${top}%`;
        danmu.style.color = `hsl(${Math.random() * 360}, 100%, 70%)`;
        
        danmuContainer.appendChild(danmu);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
            danmu.remove();
        }, 5000);
    }
    
    // æ¥æ”¶æœåŠ¡å™¨å¼¹å¹•
    function connectDanmu() {
        const eventSource = new EventSource(`/video/${'{{ video.id }}'}/danmu_stream`);
        
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            displayDanmu(data.text);
        };
    }
    
    function postComment() {
        const text = document.getElementById('commentInput').value.trim();
        if (!text) return;
        
        const btn = document.querySelector('.comment-form button');
        btn.disabled = true;
        btn.textContent = 'å‘å¸ƒä¸­...';
        
        fetch(`/video/${'{{ video.id }}'}/comment`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text: text })
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = 'å‘å¸ƒ';
            
            if (data.status === 'success') {
                // åŠ¨æ€åˆ›å»ºæ–°è¯„è®ºå…ƒç´ 
                const comment = data.comment;
                const commentsList = document.querySelector('.comments-list');
                
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${comment.time}</span>
                    </div>
                    <div class="comment-content">${comment.text}</div>
                `;
                
                // æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨é¡¶éƒ¨
                commentsList.insertBefore(commentElement, commentsList.firstChild);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('commentInput').value = '';
            } else {
                alert('è¯„è®ºå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.textContent = 'å‘å¸ƒ';
            console.error('Error:', error);
            alert('è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        });
    }
    
    // å¯åŠ¨å¼¹å¹•ç³»ç»Ÿ
    connectDanmu();
    </script>
</body>
</html>