<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.username }}的个人主页 - SyncPlay</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <style>
        .avatar-upload {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
        
        .avatar-upload input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .avatar-upload-btn {
            padding: 5px 10px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header class="dark-header">
        <div class="logo">SyncPlay</div>
        <nav>
            <a href="/">首页</a>
            {% if 'user_id' in session %}
                <a href="/upload">上传视频</a>
            {% endif %}
        </nav>
        <nav>
            <a href="https://api.amemv.com/magic/eco/runtime/release/6461f944e84c15036369f2a8?appType=douyinpc&magic_page_no=1&call_link=vega%3A%2F%2Fcom.ies.videocut%2Fmain%2Fdraft%2Fnew_draft%3F%3Ffrom%3Ddouyin_post_panel">剪映专业版</a>
        </nav>
        <div class="user-nav">
            {% if 'user_id' in session %}
                <a href="/user/{{ session['username'] }}">{{ session['username'] }}</a>
                <a href="{{ url_for('logout') }}">退出</a>
            {% else %}
                <a href="{{ url_for('login') }}">登录</a>
                <a href="{{ url_for('register') }}">注册</a>
            {% endif %}
        </div>
        <form class="search-box" action="/search" method="get">
            <input type="text" name="q" placeholder="搜索视频...">
            <button type="submit">搜索</button>
        </form>
    </header>

    <main class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                <img src="{{ url_for('static', filename='avatars/' + user.avatar) }}" 
                     id="userAvatar" alt="{{ user.username }}的头像">
                {% if 'user_id' in session and session['user_id'] == user.id %}
                <div class="avatar-upload">
                    <span class="avatar-upload-btn">更换头像</span>
                    <input type="file" id="avatarInput" accept="image/*">
                </div>
                {% endif %}
            </div>
            <div class="profile-info">
                <h1>{{ user.username }}</h1>
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-number">{{ videos|length }}</span>
                        <span class="stat-label">作品</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ user.followers }}</span>
                        <span class="stat-label">粉丝</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ user.following|length }}</span>
                        <span class="stat-label">关注</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">每日好色</span>
                    </div>
                </div>
                {% if 'user_id' in session and session['username'] != user.username %}
                <button class="follow-btn {% if user.username in current_user_following %}following{% endif %}" 
                        onclick="followUser('{{ user.username }}')">
                    {% if user.username in current_user_following %}已关注{% else %}关注{% endif %}
                </button>
                {% endif %}
            </div>
        </div>

        <div class="user-videos">
            <h2>{% if 'user_id' in session and session['user_id'] == user.id %}我的视频{% else %}他的视频{% endif %}</h2>
            {% if videos %}
            <div class="video-grid">
                {% for video in videos %}
                <div class="video-card">
                    <a href="{{ url_for('play_video', vid=video['id']) }}">
                        <div class="thumbnail-container">
                            <img src="{{ url_for('static', filename='thumbnails/' + video['thumbnail']) }}" 
                                 alt="{{ video['title'] }}">
                            <div class="duration">{{ video['duration'] }}</div>
                        </div>
                        <h3>{{ video['title'] }}</h3>
                    </a>
                    <div class="video-info">
                        <span class="views">播放: {{ video['views'] }}</span>
                        <span class="date">{{ video['upload_date'] }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-videos">该用户还没有上传任何视频</p>
            {% endif %}
        </div>
    </main>

    <footer class="dark-footer">
        <p>SyncPlay &copy; 2025</p>
    </footer>
    
    <script>
    function followUser(username) {
        fetch(`/follow/${username}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const btn = document.querySelector('.follow-btn');
                if (data.action === 'follow') {
                    btn.textContent = '已关注';
                    btn.classList.add('following');
                } else {
                    btn.textContent = '关注';
                    btn.classList.remove('following');
                }
                document.querySelector('.stat-number:nth-child(2)').textContent = data.followers;
            }
        });
    }
    
    // 头像上传功能
    document.getElementById('avatarInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('avatar', file);
        
        fetch('/upload_avatar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const avatarImg = document.getElementById('userAvatar');
                avatarImg.src = `/static/avatars/${data.avatar}?t=${new Date().getTime()}`;
                alert('头像更新成功！');
            } else {
                alert('头像上传失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('头像上传失败');
        });
    });
    </script>
</body>
</html>